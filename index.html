<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>ЧЁРНАЯ СТРЕЛА</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>

/* UX: remove orange highlight/outline on tap/focus for interactive elements */
html, body { -webkit-tap-highlight-color: transparent; }
:where(a, button, [tabindex]) { outline: none; }
:where(a, button, [tabindex]):focus,
:where(a, button, [tabindex]):focus-visible { outline: none; box-shadow: none; }

/* Perf: hint composition to smooth transform animation of the sheet */
.sheet { will-change: transform; transform: translateZ(0); }
.overlay { transform: translateZ(0); }


  @font-face {
  font-family: "Bebas Neue Pro";
  src: url("./fonts/BebasNeuePro_Regular.woff2") format("woff2");
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Bebas Neue Pro";
  src: url("./fonts/BebasNeuePro_Bold.woff2") format("woff2");
  font-weight: 700;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Bebas Neue Pro";
  src: url("./fonts/BebasNeuePro_Light.woff2") format("woff2");
  font-weight: 300;
  font-style: normal;
  font-display: swap;
}


  :root{
    --page-bg: #000;
    --content-max-w: 430px;
    --side-pad: 12px;

    --title-block-w: 100%;
    --title-top: 79px;
    --title-bottom: 100px;
    --title-size: 100px;
    --title-weight: 400;
    --title-color: #fff;
    --title-letter-spacing: .5px;
    --title-line-height: 0.86;

    --divider-width: 100%;
    --divider-thickness: 2px;
    --divider-color: #282828;
    --divider-top: 12px;
    --divider-bottom: 12px;

    --t-title-size: 13px;
    --t-title-weight: 650;
    --t-title-color: #DBDADA;

    --t-chapter-size: 12px;
    --t-chapter-weight: 650;
    --t-chapter-color: #828282;

    --t-time-size: 12px;
    --t-time-weight: 700;
    --t-time-color: #616161;

    --track-title-maxw: 295px;
    --track-text-offset: 5px;

    --aff-width: 345px;
    --aff-bg: rgba(43,43,43,.75);
    --aff-radius: 7px;
    --aff-border: 1px solid rgba(83, 83, 83, 0.2);
    --aff-text-size: 13px;
    --aff-text-weight: 750;
    --aff-text-color: #939393;
    --aff-pad-v: 14px;
    --aff-pad-h: 14px;
    --aff-blur: 4px;

    --player-bg: #000;
    --light-color: rgba(255,255,255,.55);
    --light-blur: 34px;
    --light-size: 64vw;

    --time-top-margin: 10px;
    --time-font-weight: 800;
    --time-font-size: 14px;
    --time-color: #e7e7e7;

    --btn-size: 56px;
  }

  html,body{height:100%;}
  body{
    margin:0; background:var(--page-bg); color:#fff;
    font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    overflow-x:hidden;
  }

  #stars-canvas{ position:fixed; inset:0; z-index:0; display:block; }

  .page{ position:relative; z-index:1; min-height:100dvh; display:flex; }
  .content{
    width:100%; max-width:var(--content-max-w);
    margin:0 auto; padding:0 var(--side-pad) 72px;
    box-sizing:border-box;
  }

  .title-wrap{ width:var(--title-block-w); margin:var(--title-top) auto var(--title-bottom); text-align:center; }
  .title{
    margin:0;
    font-family:"Bebas Neue Pro";
    font-size:var(--title-size);
    font-weight:var(--title-weight);
    letter-spacing:var(--title-letter-spacing);
    line-height:var(--title-line-height);
    color:var(--title-color);
    text-transform:uppercase;
  }

  .tracks{ width:100%; }
  .divider{ width:var(--divider-width); height:var(--divider-thickness); background:var(--divider-color); margin:var(--divider-top) auto var(--divider-bottom); }
  .track{ position:relative; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .track-left{ min-width:0; padding-left:var(--track-text-offset); }
  .track-title{ max-width:var(--track-title-maxw); font-size:var(--t-title-size); font-weight:var(--t-title-weight); color:var(--t-title-color); line-height:1.25; }
  .track-chapter{ margin-top:2px; font-size:var(--t-chapter-size); font-weight:var(--t-chapter-weight); color:var(--t-chapter-color); }
  .track-time{ margin-left:auto; flex:0 0 auto; font-size:var(--t-time-size); font-weight:var(--t-time-weight); color:var(--t-time-color); }

  .aff-card{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:var(--aff-width); padding:var(--aff-pad-v) var(--aff-pad-h); background:var(--aff-bg); border:var(--aff-border); border-radius:var(--aff-radius); text-align:center; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:2; backdrop-filter:blur(var(--aff-blur)); }
  .aff-text{ font-size:var(--aff-text-size); font-weight:var(--aff-text-weight); color:var(--aff-text-color); line-height:1.2; opacity:0; transition: opacity .6s ease; }
  .aff-text.show{ opacity:1; }

  .player{ width:100%; max-width:var(--content-max-w); margin:36px auto 80px; padding:0 var(--side-pad); box-sizing:border-box; background:var(--player-bg); display:none; }
  :target.player{ display:block; }

  .player .header{ position:relative; width:100%; }
  .player .light{ position:absolute; left:50%; top:0; width:var(--light-size); height:var(--light-size); transform:translate(-50%,-42%); border-radius:50%; background:radial-gradient(circle, var(--light-color) 0%, rgba(0,0,0,0) 60%); filter:blur(var(--light-blur)); pointer-events:none; z-index:0; }
  .player .svg-player{ position:relative; z-index:1; width:100%; }

  .player h2{ margin:16px 0 4px; font-weight:900; font-size:18px; line-height:1.2; }
  .player .chapter{ margin:0 0 10px; font-weight:800; font-size:14px; opacity:.95; }

  .progress{ width:100%; height:6px; background:#262626; border-radius:999px; position:relative; overflow:hidden; }
  .progress__bar{ position:absolute; left:0; top:0; bottom:0; width:0%; background:#f2f2f2; border-radius:999px; }
  .time{ margin-top:var(--time-top-margin); display:flex; justify-content:space-between; font: var(--time-font-weight) var(--time-font-size)/1.1 system-ui; color:var(--time-color); }

  .controls{ margin-top:14px; display:flex; justify-content:space-between; gap:10px; }
  .btn{ display:grid; place-items:center; width:var(--btn-size); height:var(--btn-size); background:transparent; border:0; padding:0; }
  .btn svg{ width:100%; height:100%; display:block; }
</style>
</head>
<body>

<canvas id="stars-canvas" aria-hidden="true"></canvas>

<main class="page">
  <section class="content">
    <div class="title-wrap">
      <h1 class="title">ЧЁРНАЯ СТРЕЛА</h1>
    </div>

    <div class="tracks" id="tracks">
      <article class="track" data-title="Трек 1" data-part="Глава 1" data-src="audio/01.mp3" data-cover="img/01.jpg">
        <div class="track-left">
          <div class="track-title" data-title>Джон мщу-за-всех</div>
          <div class="track-chapter">Пролог</div>
        </div>
        <time class="track-time">12:34</time>
      </article>

      <div class="divider"></div>

      <article class="track" data-title="Трек 2" data-part="Глава 2" data-src="audio/02.mp3" data-cover="img/02.jpg">
        <div class="track-left">
          <div class="track-title" data-title>Джон мщу-за-всех</div>
          <div class="track-chapter">Пролог</div>
        </div>
        <time class="track-time">12:34</time>

        <div class="aff-card" role="status" aria-live="polite">
          <div class="aff-text" id="affText">Я люблю тебя &lt;З</div>
        </div>
      </article>

      <div class="divider"></div>
    </div>

    </section>
</main>

<script>
(() => {
  const phrases = [
    'Я люблю тебя <З',
    'У тебя всё получится!',
    'Ты умничка <З',
    'Я горжусь тобой!',
    'Ты прекрасна',
    'Ты моё солнышко <З'
  ];
  const el = document.getElementById('affText');
  if(!el) return;
  let i = 0;

  const getDur = () => {
    const d = getComputedStyle(el).transitionDuration.split(',')[0].trim();
    if (d.endsWith('ms')) return parseFloat(d) || 600;
    if (d.endsWith('s')) return (parseFloat(d) || 0.6) * 1000;
    return 600;
  };
  const D = getDur();

  function cycle(){
    el.classList.remove('show');
    setTimeout(() => {
      i = (i+1) % phrases.length;
      el.textContent = phrases[i];
      requestAnimationFrame(() => el.classList.add('show'));
    }, D);
  }

  el.textContent = phrases[i];
  requestAnimationFrame(() => el.classList.add('show'));
  setInterval(cycle, 7000);
})();

(() => {
  const getCSS = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
  const ruler = document.createElement('span');
  Object.assign(ruler.style,{
    position:'absolute', visibility:'hidden', whiteSpace:'nowrap',
    fontSize: getCSS('--t-title-size'),
    fontWeight: getCSS('--t-title-weight'),
    fontFamily: getComputedStyle(document.body).fontFamily
  });
  document.body.appendChild(ruler);

  document.querySelectorAll('.track-title[data-title]').forEach(el=>{
    const maxW = parseFloat(getCSS('--track-title-maxw'));
    const txt = el.textContent.trim().replace(/\s+/g,' ');
    el.setAttribute('title', txt);

    ruler.textContent = txt;
    if (ruler.offsetWidth <= maxW) return;

    const words = txt.split(' ');
    let out = '';
    for(let k=0;k<words.length;k++){
      const next = (out ? out+' ' : '') + words[k];
      ruler.textContent = next + '…';
      if (ruler.offsetWidth <= maxW){ out = next; continue; }

      if (words[k].length >= 7){
        let cut = words[k];
        while (cut.length > 1){
          cut = cut.slice(0,-1);
          const cand = (out ? out+' ' : '') + cut + '…';
          ruler.textContent = cand;
          if (ruler.offsetWidth <= maxW){ out = (out? out+' ' : '') + cut; break; }
        }
      }
      break;
    }
    el.textContent = out + '…';
  });
})();

</script>
<!-- === AUDIO SHEET v3 (Shadow DOM, fast re-open, -15/+30 skip) === -->
<script>
(() => {
  // Simple state machine
  const State = { IDLE:0, OPENING:1, OPEN:2, CLOSING:3 };

  class AudioSheet extends HTMLElement {
    constructor(){
      super();
      this._state = State.IDLE;
      const root = this.attachShadow({mode:'open'});
      root.innerHTML = `
        <style>
          :host { all: initial; }
          :host{ --sheet-max-w: 700px; --sheet-radius-top: 18px; --sheet-radius-current: var(--sheet-radius-top); }
          :host, * { box-sizing: border-box; }
          .overlay { position: fixed; inset: 0; display: grid; align-content: end; justify-items: center;
                     background: transparent; backdrop-filter: none; pointer-events: none; z-index: 999999;
                     transition: background 160ms linear; }
          .overlay.open { background: rgba(7,6,8,0.55); backdrop-filter: blur(8px); pointer-events: auto; }

          .sheet { width: 100vw; height: 100dvh; box-sizing: border-box;
                   background: rgba(33,33,33,.9); color: #F3F2F7;
                   border-radius: 0 0 0 0;
                   box-shadow: 0 1px 60px rgba(0,0,0,.6), 0 1px 0 rgba(255,255,255,.04) inset; overflow:hidden;
                   padding: clamp(16px,3.2vw,36px) clamp(16px,3.2vw,40px) calc(clamp(16px,3.2vw,40px) + env(safe-area-inset-bottom));
                   display: flex; flex-direction: column; gap: clamp(12px,2.2vw,20px);
                   transform: translateY(100%);
                   transition: transform var(--open-dur, 250ms) cubic-bezier(.2,.9,.2,1);
                   touch-action: none; will-change: transform, border-radius; }

          .cover { height: clamp(290px, 32vw, 390px); display:grid; place-items:center; margin-top: clamp(24px,8vh,120px); }
          .img { width: clamp(282px, 32vw, 382px); height: clamp(282px, 32vw, 382px);
                 background:#C4C4C4 center/cover no-repeat;
                 border-radius: clamp(10px,1.4vw,16px); box-shadow: 0 6px 22px rgba(0,0,0,.4); overflow:hidden; }

          .meta { text-align: center; }
          .title { position:relative; font: 800 clamp(18px,2.4vw,28px)/1.12 system-ui, -apple-system, Segoe UI, Roboto, Arial;
                   color:#fff; height:1.25em; white-space:nowrap; overflow:hidden;
                   -webkit-mask-image:linear-gradient(to right, transparent 0%, #000 9%, #000 91%, transparent 100%);
                           mask-image:linear-gradient(to right, transparent 0%, #000 9%, #000 91%, transparent 100%); }
          .title .track { display:inline-flex; gap:24px; will-change: transform; }
          .title.marquee .track { animation: marquee var(--dur, 14s) linear infinite; }
          @keyframes marquee { from { transform: translateX(0) } to { transform: translateX(calc(-1 * var(--dist, 0px))) } }
          .author { color:#BDBDBD; font: 700 clamp(14px,1.8vw,18px)/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial; }

          .progress-wrap{ width:min(100%, clamp(305px, 60vw, 475px)); margin: 0 auto; }
          .bar{ height:5px; background:rgba(255,255,255,.14); border-radius:999px; position:relative; }
          .fill{ height:100%; width:0%; background:#fff; border-radius:999px; transition: width .18s linear; }
          .time{ display:flex; justify-content:space-between; color:#BEBEBE; font: 600 12px system-ui; margin-top:6px; }

          .controls{ display:flex; gap: clamp(22px,2vw,28px); justify-content:center; align-items:center; margin:46px 0 6px; flex-wrap: nowrap; }
          .btn{ all: unset; width: clamp(39px,6vw,48px); height: clamp(39px,6vw,48px); border-radius: 999px; display:grid; place-items:center; cursor:pointer; }
          .btn.play{ width: clamp(61px,7vw,73px); height: clamp(61px,7vw,73px); }
          .glyph{ width:100%; height:100%; background-repeat:no-repeat; background-position:center; background-size:contain; }

          /* temp icons */
          .icon-play{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='52' height='52' fill='none'><ellipse cx='26' cy='26' rx='26' ry='26' fill='%23FFF'/><path fill='%23282729' d='M20 18v16l16-8-16-8Z'/></svg>"); }
          .icon-pause{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='52' height='52' fill='none'><ellipse cx='26' cy='26' rx='26' ry='26' fill='%23FFF'/><g fill='%23282729'><rect x='19' y='16' width='6' height='20' rx='2'/><rect x='27' y='16' width='6' height='20' rx='2'/></g></svg>"); }
          .icon-prev{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' fill='none'><g fill='%23FFF'><path d='M16 6v16L4 14l12-8Z'/><rect x='20' y='6' width='2' height='16' rx='1'/></g></svg>"); }
          .icon-next{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' fill='none'><g fill='%23FFF'><path d='M12 22V6l12 8-12 8Z'/><rect x='6' y='6' width='2' height='16' rx='1'/></g></svg>"); }
          .icon-back15{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44' fill='none'><circle cx='22' cy='22' r='22' fill='rgba(255,255,255,.18)'/><path stroke='%23FFF' stroke-width='2' d='M18 16l-6 6 6 6'/><text x='24' y='26' fill='%23FFF' font-family='Arial' font-size='10' font-weight='700'>15</text></svg>"); }
          .icon-fwd30{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44' fill='none'><circle cx='22' cy='22' r='22' fill='rgba(255,255,255,.18)'/><path stroke='%23FFF' stroke-width='2' d='M26 16l6 6-6 6'/><text x='10' y='26' fill='%23FFF' font-family='Arial' font-size='10' font-weight='700'>30</text></svg>"); }
        </style>
        <div class="overlay" aria-hidden="true">
          <div class="sheet" role="dialog" aria-label="Аудиоплеер">
            <div class="cover"><div class="img" id="cover" aria-hidden="true"></div></div>
            <div class="meta">
              <div class="title" id="title"><span>Название</span></div>
              <div class="author" id="author">Автор</div>
            </div>
            <div class="progress-wrap">
              <div class="bar"><div class="fill" id="fill"></div></div>
              <div class="time"><span id="cur">00:00</span><span id="dur">00:00</span></div>
            </div>
            <div class="controls">
              <button class="btn" id="prev"><div class="glyph icon-prev"></div></button>
              <button class="btn" id="back15" title="-15 сек"><div class="glyph icon-back15"></div></button>
              <button class="btn play" id="pp"><div class="glyph icon-play" id="glyph"></div></button>
              <button class="btn" id="fwd30" title="+30 сек"><div class="glyph icon-fwd30"></div></button>
              <button class="btn" id="next"><div class="glyph icon-next"></div></button>
            </div>
            <audio id="audio" preload="metadata"></audio>
          </div>
        </div>
      `;

      // refs
      const $o = this.$o = root.querySelector('.overlay');
      const $s = this.$s = root.querySelector('.sheet');
      this.$title = root.querySelector('#title');
      this.$author = root.querySelector('#author');
      this.$cover = root.querySelector('#cover');
      this.$fill = root.querySelector('#fill');
      this.$cur = root.querySelector('#cur');
      this.$dur = root.querySelector('#dur');
      this.$pp = root.querySelector('#pp');
      this.$glyph = root.querySelector('#glyph');
      this.$prev = root.querySelector('#prev');
      this.$next = root.querySelector('#next');
      this.$back15 = root.querySelector('#back15');
      this.$fwd30 = root.querySelector('#fwd30');
      this.$audio = root.querySelector('#audio');

      

      
      // Helper: parse CSS time like '570ms' or '0.57s' to ms
      const _parseMs = (v)=>{
        v = String(v||'').trim();
        if (!v) return 570;
        if (v.endsWith('ms')) return Math.max(1, parseFloat(v));
        if (v.endsWith('s'))  return Math.max(1, parseFloat(v) * 1000);
        const n = parseFloat(v); return isFinite(n) ? Math.max(1, n) : 570;
      };
      const _getOpenDurMs = ()=> _parseMs(getComputedStyle(this.$s).getPropertyValue('--open-dur'));
// === Radius config & helper ===
      this.R_OPEN =  0;
      if (!isFinite(this.R_OPEN)) this.R_OPEN = 18;
      this.R_CLOSED =  0;
      if (!isFinite(this.R_CLOSED)) this.R_CLOSED = 18;
      this.setRadiusByPct = (pct)=>{ /* no-op: rounding removed */ };
// state
      this.playlist = [];
      this.index = 0;
      this._playing = false;

      // helpers
      const sec = (s)=>{ if(!isFinite(s)) return "00:00"; s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), ss=String(s%60).padStart(2,'0'); return `${String(m).padStart(2,'0')}:${ss}`; };
      const clamp = (v, a, b) => Math.min(b, Math.max(a, v));

      // audio events
      this.$audio.addEventListener('loadedmetadata', ()=> {
        this.$dur.textContent = sec(this.$audio.duration);
        this.renderProgress();
      });
      this.$audio.addEventListener('timeupdate', ()=> this.renderProgress());
      this.$audio.addEventListener('play', ()=>{ this._playing = true; this.$glyph.classList.remove('icon-play'); this.$glyph.classList.add('icon-pause'); });
      this.$audio.addEventListener('pause', ()=>{ this._playing = false; this.$glyph.classList.add('icon-play'); this.$glyph.classList.remove('icon-pause'); });
      this.$audio.addEventListener('ended', ()=>{ this._playing = false; this.$glyph.classList.add('icon-play'); this.$glyph.classList.remove('icon-pause'); });

      // controls
      this.$pp.addEventListener('click', ()=> {
        if (!this.$audio.src) return;
        if (this._playing) this.$audio.pause(); else this.$audio.play().catch(()=>{});
      });
      this.$prev.addEventListener('click', ()=> { if(this.index>0){ this.loadByIndex(this.index-1); } });
      this.$next.addEventListener('click', ()=> { if(this.index+1<this.playlist.length){ this.loadByIndex(this.index+1); } });
      this.$back15.addEventListener('click', ()=> {
        if (!this.$audio.src || !isFinite(this.$audio.duration)) return;
        this.$audio.currentTime = clamp(this.$audio.currentTime - 15, 0, this.$audio.duration);
        this.renderProgress();
      });
      this.$fwd30.addEventListener('click', ()=> {
        if (!this.$audio.src || !isFinite(this.$audio.duration)) return;
        this.$audio.currentTime = clamp(this.$audio.currentTime + 30, 0, this.$audio.duration);
        this.renderProgress();
      });

      // Close handlers
      $o.addEventListener('click', (e)=> { if (this._openedAt && (performance.now() - this._openedAt) < 350) return; if (e.target === $o) this.close(); });
      window.addEventListener('keydown', (e)=> { if (e.key === 'Escape') this.close(); });

      // Drag-to-close
      let dragging=false, startY=0, curPct=0;
      const onDown = (e)=>{
      dragging=true; 
      startY=('touches'in e?e.touches[0].clientY:e.clientY);
      // show rounding at drag start
      $s.style.transition='border-radius 120ms linear, transform 260ms cubic-bezier(.2,.9,.2,1)';
      this.$s.style.setProperty('--sheet-radius-current', getComputedStyle(this).getPropertyValue('--sheet-open-radius') || '18px');
    };
      const onMove = (e)=>{
      if(!dragging) return;
      const y=('touches'in e?e.touches[0].clientY:e.clientY);
      const dy=y-startY, h=$s.getBoundingClientRect().height||1;
      const pct=Math.max(0, Math.min(1, dy/h)); curPct=pct;
      $s.style.transform = `translateY(${pct*100}%)`;
      // keep rounding constant during drag
    };
      const onUp = ()=>{
      if(!dragging) return; dragging=false;
      $s.style.transition='transform 260ms cubic-bezier(.2,.9,.2,1)';
      const willClose = (curPct > 0.06);
      if (willClose){
        // close via component logic (removes blur and resets vars)
        this._hideOverlay();
      } else {
        // snap back open and remove rounding fast
        $s.style.transform='translateY(0%)';
        this.$s.style.setProperty('--sheet-radius-current', '0px');
      }
    };
      $s.addEventListener('touchstart', onDown, {passive:true});
      window.addEventListener('touchmove', onMove, {passive:true});
      window.addEventListener('touchend', onUp);

      // progress render
      this.renderProgress = ()=>{
        if (!isFinite(this.$audio.duration) || this.$audio.duration<=0){
          this.$fill.style.width = "0%";
          this.$cur.textContent = "00:00";
          return;
        }
        const pct = (this.$audio.currentTime / this.$audio.duration) * 100;
        this.$fill.style.width = pct + "%";
        this.$cur.textContent = sec(this.$audio.currentTime);
      };

      // ensure initial CSS values
      this._resetSheetInstant();
    }

    _resetSheetInstant(){
      // reset transform without animating
      this.$s.style.transition = 'none';
      this.$s.style.transform = 'translateY(100%)';}

    _showOverlay(){
      if (this._state === State.OPEN || this._state === State.OPENING) return;
      this._state = State.OPENING;
      // show overlay immediately; start anim next frame
      this.$o.classList.add('open');
      this.$o.setAttribute('aria-hidden','false');
      // two RAFs to ensure styles apply before transition
      requestAnimationFrame(()=>{
        this.$s.style.transition = 'transform var(--open-dur, 570ms) cubic-bezier(.2,.9,.2,1)';
        this.$s.style.transform = 'translateY(0%)';this._openedAt = performance.now();
        // reference: fully-open sheet has no rounding
        this.$s.style.setProperty('--sheet-radius-current', '0px');
        
        // (radius schedule removed to follow reference mechanics)this._openedAt = performance.now();
        // set state to OPEN when transition ends (guarded)
        const onEnd = () => { this._state = State.OPEN; this.$s.removeEventListener('transitionend', onEnd); };
        this.$s.addEventListener('transitionend', onEnd);
      });
    }

    _hideOverlay(){
      // animate out first, then hide overlay and reset
      if (this._state !== State.OPEN && this._state !== State.OPENING) return;
      this._state = State.CLOSING;
      this.$s.style.transition = 'transform 320ms cubic-bezier(.2,.9,.2,1)';
      this.$s.style.transform = 'translateY(100%)';
      const onEnd = () => {
        this.$o.classList.remove('open');
        this.$o.setAttribute('aria-hidden','true');
        this.$audio.pause();
        this._playing = false;
        this._resetSheetInstant();
        this._state = State.IDLE;
        this.$s.removeEventListener('transitionend', onEnd);
      };
      this.$s.addEventListener('transitionend', onEnd);
    }

    setPlaylist(list, startIndex=0){
      this.playlist = Array.isArray(list) ? list : [];
      this.index = Math.min(Math.max(0, startIndex|0), Math.max(this.playlist.length-1,0));
      // nav buttons state could be updated here if we dim them in future
    }

    load(track){
      const t = track || this.playlist[this.index] || {};
      const title = t.partTitle || t.title || 'Без названия';
      const author = t.partLabel || t.author || '';
      // title marquee
      this.$title.classList.remove('marquee');
      this.$title.innerHTML = '';
      const tr = document.createElement('div'); tr.className = 'track';
      const s1 = document.createElement('span'); s1.textContent = title;
      const s2 = document.createElement('span'); s2.textContent = title; s2.setAttribute('aria-hidden','true');
      tr.appendChild(s1); tr.appendChild(s2); this.$title.appendChild(tr);
      requestAnimationFrame(()=>{
        const boxW = this.$title.clientWidth, textW = s1.scrollWidth;
        if (textW > boxW + 2){
          const gap = 24; this.$title.style.setProperty('--dist', (textW + gap) + 'px');
          const duration = Math.max(8, (textW + gap) / 18); this.$title.style.setProperty('--dur', duration + 's');
          this.$title.classList.add('marquee');
        } else {
          this.$title.classList.remove('marquee'); this.$title.textContent = title;
        }
      });
      this.$author.textContent = author || '';
      this.$cover.style.backgroundImage = t.cover ? `url("${t.cover.replace(/"/g,'\\"')}")` : 'none';
      this.$audio.src = t.src || '';
    }

    open(track){
      // prepare data
      if (track) this.load(track); else this.load();
      // fast reaction: ensure we reset then show overlay asap
      this._resetSheetInstant();
      this._showOverlay();
    }

    close(){ this._hideOverlay(); }
  }

  customElements.define('x-audio-sheet', AudioSheet);

  // Mount single instance
  const sheetEl = document.createElement('x-audio-sheet');
  document.documentElement.appendChild(sheetEl);

  // Public API
  window.AudioSheet = {
    open: (track) => sheetEl.open(track),
    setPlaylist: (list, i) => sheetEl.setPlaylist(list, i),
  };

  // ====== Binding: fast pointerdown on active cards ======
  function getMeta(node){
    const title = node.getAttribute('data-title')
              || node.querySelector('.track-title')?.textContent?.trim()
              || node.textContent?.trim()
              || 'Аудио';
    const label = node.getAttribute('data-part') 
              || node.querySelector('.track-chapter')?.textContent?.trim()
              || '';
    const src = node.getAttribute('data-src') || '';
    const cover = node.getAttribute('data-cover') || '';
    return { partTitle: title, partLabel: label, src, cover };
  }

  const OPEN_SELECTOR = '.track, [data-open-player]';

  // Fast reaction: pointerdown; fallback: keydown/Enter Space; click for legacy
  document.addEventListener('pointerdown', (ev) => {
    const n = ev.target.closest(OPEN_SELECTOR);
    if (!n) return;
    if (n.getAttribute('data-active') === '0') return;
    // prevent accidental text selection on long press
    const meta = getMeta(n);
    window.AudioSheet.open(meta);
  });

  document.addEventListener('keydown', (ev) => {
    if (ev.key !== 'Enter' && ev.key !== ' ') return;
    const n = ev.target.closest(OPEN_SELECTOR);
    if (!n) return;
    if (n.getAttribute('data-active') === '0') return;
    ev.preventDefault();
    const meta = getMeta(n);
    window.AudioSheet.open(meta);
  });

  // Keep legacy click but it usually fires after pointerdown; this is harmless
  document.addEventListener('pointerdown', (ev) => {
    const n = ev.target.closest(OPEN_SELECTOR);
    if (!n) return;
    if (n.getAttribute('data-active') === '0') return;
    if (n.tagName === 'A') ev.preventDefault();
  });
})();
</script>
<script>
(function(){
  function openFromCard(card){
    const meta = {
      partTitle: card.getAttribute('data-title') || card.querySelector('.track-title')?.textContent?.trim() || 'Без названия',
      partLabel: card.getAttribute('data-part')  || card.querySelector('.track-chapter')?.textContent?.trim() || '',
      src: card.getAttribute('data-src') || '',
      cover: card.getAttribute('data-cover') || ''
    };
    if (!meta.src) return;
    if (window.AudioSheet && typeof window.AudioSheet.open === 'function'){
      window.AudioSheet.open(meta);
    } else {
      console.error('[AudioSheet] Глобальный объект не найден. Проверь загрузку скрипта компонента.');
    }
  }

  function bind(){
    document.querySelectorAll('.track[data-src]').forEach(card => {
      // avoid double-binding
      if (card.__xa_bound) return;
      card.__xa_bound = true;
      card.addEventListener('pointerdown', () => openFromCard(card));
      card.addEventListener('click', () => openFromCard(card));
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openFromCard(card); }
      });
      card.tabIndex = card.tabIndex || 0;
      card.setAttribute('role', 'button');
      card.setAttribute('aria-label', (card.getAttribute('data-title')||'Открыть аудиоплеер'));
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>


</body>
</html>
